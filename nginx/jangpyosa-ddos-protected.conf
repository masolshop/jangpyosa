# ============================================
# 장표사닷컴 - DDoS 방어가 적용된 Nginx 설정
# ============================================

# HTTP -> HTTPS 리다이렉트
server {
    listen 80;
    listen [::]:80;
    server_name jangpyosa.com www.jangpyosa.com;

    # Rate limiting 적용
    limit_conn conn_limit 20;
    limit_req zone=page_limit burst=50 nodelay;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name jangpyosa.com www.jangpyosa.com;

    # SSL 인증서
    ssl_certificate /etc/letsencrypt/live/jangpyosa.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/jangpyosa.com/privkey.pem;

    # ============================================
    # SSL 보안 강화 (A+ 등급)
    # ============================================
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

    # ============================================
    # 보안 헤더 강화
    # ============================================
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; font-src 'self' https://cdn.jsdelivr.net; img-src 'self' data: https:;" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # ============================================
    # DDoS 방어 설정
    # ============================================
    
    # 동시 연결 수 제한 (IP당 최대 20개)
    limit_conn conn_limit 20;
    
    # 클라이언트 업로드 크기 제한
    client_max_body_size 10M;
    client_body_buffer_size 128K;
    
    # 타임아웃 설정 (슬로우 로리스 공격 방어)
    client_body_timeout 10s;
    client_header_timeout 10s;
    send_timeout 10s;
    keepalive_timeout 15s;
    
    # 버퍼 크기 제한
    large_client_header_buffers 2 1k;
    
    # 서버 버전 숨기기
    server_tokens off;

    # ============================================
    # 로그인 엔드포인트 (강력한 제한)
    # ============================================
    location ~ ^/api/(auth|login) {
        limit_req zone=login_limit burst=5 nodelay;
        limit_conn conn_limit 5;
        
        # 브루트포스 공격 차단
        if ($request_method !~ ^(POST)$) {
            return 444;
        }
        
        proxy_pass http://localhost:4000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 30s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
    }

    # ============================================
    # API 엔드포인트 (중간 수준 제한)
    # ============================================
    location /api/ {
        limit_req zone=api_limit burst=20 nodelay;
        limit_conn conn_limit 10;
        
        # API 요청만 허용
        if ($request_method !~ ^(GET|POST|PUT|DELETE|PATCH)$) {
            return 444;
        }
        
        proxy_pass http://localhost:4000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 60s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        
        # CORS 헤더
        add_header 'Access-Control-Allow-Origin' '$http_origin' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
    }

    # ============================================
    # Web 프록시 (일반 페이지)
    # ============================================
    location / {
        limit_req zone=page_limit burst=50 nodelay;
        limit_conn conn_limit 15;
        
        # 일반 HTTP 메서드만 허용
        if ($request_method !~ ^(GET|POST|HEAD)$) {
            return 444;
        }
        
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 60s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
    }

    # ============================================
    # 정적 파일 캐시 및 최적화
    # ============================================
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|webp)$ {
        proxy_pass http://localhost:3000;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        
        # 정적 파일도 제한 적용
        limit_req zone=page_limit burst=100 nodelay;
    }

    # ============================================
    # 숨겨진 파일 및 민감한 파일 차단
    # ============================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~ \.(env|git|gitignore|htaccess|htpasswd|ini|log|sh|sql|tar|gz)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ============================================
    # 봇 및 악의적인 User-Agent 차단
    # ============================================
    if ($http_user_agent ~* (bot|crawler|spider|scraper|nikto|sqlmap|havij|scan)) {
        return 403;
    }
    
    # ============================================
    # 에러 페이지 커스터마이징
    # ============================================
    error_page 429 /429.html;
    error_page 500 502 503 504 /50x.html;
    
    location = /429.html {
        root /usr/share/nginx/html;
        internal;
    }
    
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }
}
