# 📋 여러 표준사업장 동시 계약 지원 기능 완료 보고서

## ✅ 완료된 작업

### **핵심 개선사항**
부담금 기업이 **2개 이상의 표준사업장**과 동시에 계약할 수 있도록 장바구니 기능을 대폭 강화했습니다.

---

## 🎯 1️⃣ 합산 감면 계산 API 추가

### **API 엔드포인트**
- **URL**: `POST /reduction/aggregate`
- **파일**: `/home/user/webapp/apps/api/src/routes/reduction.ts`

### **계산 로직**
```typescript
1. 도급액 합산
   - 여러 표준사업장의 도급액을 합산

2. 감면 상한 계산
   - 감면상한1 = 부담금 × 90%
   - 감면상한2 = 전체 도급액 × 50%
   - 최대감면액 = min(감면상한1, 감면상한2)

3. 감면 후 부담금
   - 감면 후 부담금 = 부담금 - 최대감면액

4. 공급사별 감면액 비례 배분
   - 각 공급사의 감면액 = 최대감면액 × (해당 공급사 도급액 / 총 도급액)
```

### **요청 예시**
```json
{
  "year": 2025,
  "levyAmount": 20000000,
  "contractAmounts": [5000000, 3000000, 2000000]
}
```

### **응답 예시**
```json
{
  "ok": true,
  "year": 2025,
  "levyAmount": 20000000,
  "contractCount": 3,
  "totalContractAmount": 10000000,
  "capByLevy": 18000000,
  "capByContract": 5000000,
  "maxReduction": 5000000,
  "afterReduction": 15000000,
  "supplierReductions": [
    { "index": 0, "contractAmount": 5000000, "ratio": 0.5, "reduction": 2500000 },
    { "index": 1, "contractAmount": 3000000, "ratio": 0.3, "reduction": 1500000 },
    { "index": 2, "contractAmount": 2000000, "ratio": 0.2, "reduction": 1000000 }
  ],
  "rule": "감면총액은 부담금의 90% 이내이며 도급액 합계의 50%를 초과할 수 없습니다.",
  "warning": "본 계산은 추정치이며 실제 감면액은 계약 내용, 월별 이행 여부 및 공단 심사 결과에 따라 달라질 수 있습니다."
}
```

---

## 🛒 2️⃣ 장바구니 페이지 대폭 강화

### **주요 개선사항**

#### **A. 공급사별 그룹화 표시**
- 장바구니에 담긴 상품을 **공급사별로 그룹화**하여 표시
- 각 공급사의 총 도급액을 별도로 계산하여 표시
- 시각적으로 구분 (파란색 테두리, 회사명 강조)

#### **B. 합산 감면 계산기**
- **위치**: 장바구니 중간 부분 (보라색 그라데이션 박스)
- **입력**: 기업의 예상 부담금
- **계산 버튼**: "🧮 합산 감면액 계산하기"
- **결과 표시**:
  - 계약 건수 (공급사 수)
  - 총 도급액
  - 예상 부담금
  - 감면 상한 계산 (부담금 기준 90%, 도급액 기준 50%)
  - 최종 감면 가능액 (노란색 강조)
  - 감면 후 부담금 (절감액 표시)
- **민원 방지 문구**: 계산 결과 하단에 경고 메시지 표시

#### **C. 1년 감면 진행 상황표 (월별 체크리스트)**
- **버튼**: "📅 1년 감면 진행 상황표 보기" (초록색)
- **모달 내용**:
  - 12개월 체크박스 (월별 이행 완료 체크)
  - 진행 현황 (완료 개월수 / 12개월)
  - 진행률 시각화 (프로그레스 바)
  - 월별 이행 프로세스 안내 (5단계)
  - 주의사항 (빨간색 박스)

#### **D. 개선된 UI/UX**
- 공급사별 상품 그룹화
- 총 도급 금액 및 계약 업체 수 표시
- 감면 계산 결과를 시각적으로 명확하게 표시
- 민원 방지 문구 강조

---

## 📊 3️⃣ 데이터 흐름

### **합산 감면 계산 프로세스**
```
1. 사용자가 여러 표준사업장 상품을 장바구니에 추가
2. 장바구니 페이지에서 공급사별 그룹화 표시
3. 사용자가 예상 부담금 입력
4. "합산 감면액 계산하기" 버튼 클릭
5. Frontend: 공급사별 도급액 배열 생성
6. API 호출: POST /reduction/aggregate
7. Backend: 감면 상한 계산 (90% + 50% 한도)
8. Backend: 최종 감면액 계산 및 공급사별 배분
9. Frontend: 계산 결과 표시 (상한, 감면액, 절감액)
10. Frontend: 민원 방지 문구 표시
```

### **1년 진행 상황표 프로세스**
```
1. 사용자가 "1년 감면 진행 상황표 보기" 버튼 클릭
2. 모달 팝업 표시 (12개월 체크리스트)
3. 사용자가 월별 이행 완료 체크
4. 진행 현황 자동 계산 및 프로그레스 바 업데이트
5. 월별 이행 프로세스 안내 표시
6. 주의사항 강조 표시
```

---

## 🎯 4️⃣ 민원 방지 효과

### **A. 합산 감면 계산**
✅ 여러 표준사업장 계약 시 감면 상한 자동 적용  
✅ 부담금 90% 한도 + 도급액 50% 한도 동시 계산  
✅ 최종 감면액을 명확하게 표시 (두 한도 중 작은 값)  
✅ 공급사별 감면액 비례 배분 (투명성 확보)  
✅ 민원 방지 문구 필수 표시

### **B. 1년 진행 상황표**
✅ 월별 이행 관리 가능 (12개월 체크리스트)  
✅ 진행 현황 실시간 확인 (프로그레스 바)  
✅ 월별 이행 프로세스 명확히 안내  
✅ 주의사항 강조 (계약서만으로는 감면 불가)  
✅ 이행 증빙 자료 보관 안내

### **C. 제도 준수**
✅ 공단 FAQ와 일치 (2개 이상 표준사업장 계약 가능)  
✅ 감면 상한 정확히 적용 (부담금 90%, 도급액 50%)  
✅ 월별 이행 기준 명확히 안내  
✅ 법적 근거 제시 (장애인고용촉진 및 직업재활법 제33조)

---

## 🔍 5️⃣ 주요 파일 변경 사항

### **1. Backend (API)**
- **신규 파일**: `/home/user/webapp/apps/api/src/routes/reduction.ts`
  - 합산 감면 계산 API 구현
  - Zod 스키마 검증
  - 감면 상한 계산 로직
  - 공급사별 감면액 비례 배분
  
- **수정 파일**: `/home/user/webapp/apps/api/src/index.ts`
  - reduction 라우트 추가

### **2. Frontend (Web)**
- **수정 파일**: `/home/user/webapp/apps/web/src/app/cart/page.tsx`
  - 공급사별 그룹화 UI 추가
  - 합산 감면 계산기 UI 추가
  - 1년 진행 상황표 모달 추가
  - 민원 방지 문구 추가

---

## 💡 6️⃣ 사용 시나리오

### **시나리오 1: 중소기업 A사 (부담금 2천만원)**

1. **상황**: 
   - 예상 부담금: 20,000,000원
   - 3개 표준사업장 계약 예정
   
2. **장바구니 구성**:
   - 표준사업장 A: 5,000,000원 (인쇄/출판)
   - 표준사업장 B: 3,000,000원 (포장/배송)
   - 표준사업장 C: 2,000,000원 (세차/세탁)
   - **총 도급액**: 10,000,000원

3. **합산 감면 계산 결과**:
   - 감면상한1 (부담금 90%): 18,000,000원
   - 감면상한2 (도급액 50%): 5,000,000원
   - **최종 감면액**: 5,000,000원 (두 한도 중 작은 값)
   - **감면 후 부담금**: 15,000,000원
   - **절감액**: 5,000,000원 (25% 절감)

4. **1년 진행 상황 관리**:
   - 매월 3개 업체에서 납품 완료 체크
   - 진행률 모니터링 (프로그레스 바)
   - 분기별 감면 신청 준비

---

## 🚀 7️⃣ 배포 상태

- ✅ 합산 감면 계산 API 구현 완료
- ✅ 장바구니 페이지 UI 강화 완료
- ✅ 1년 진행 상황표 구현 완료
- ✅ TypeScript 컴파일 완료 (API, Web)
- ✅ PM2로 서비스 시작 완료
  - `jangpyosa-api` (포트 4000)
  - `jangpyosa-web` (포트 3000)
- ✅ Git 커밋 완료 (커밋 메시지: "합산 감면 계산 + 1년 진행 상황표 추가: 여러 표준사업장 동시 계약 지원")

---

## 🔗 8️⃣ 데모 URL

- **장바구니 페이지**: https://3000-i9nss1cey8kihvk6alb7i-02b9cc79.sandbox.novita.ai/cart
- **메인 페이지**: https://3000-i9nss1cey8kihvk6alb7i-02b9cc79.sandbox.novita.ai/
- **카탈로그**: https://3000-i9nss1cey8kihvk6alb7i-02b9cc79.sandbox.novita.ai/catalog

---

## 📝 9️⃣ 향후 개선 사항

### **1. 합산 감면 계산**
- [ ] 계산 결과 PDF 다운로드 기능
- [ ] 공급사별 계약서 자동 생성
- [ ] 감면 예상액 시뮬레이션 (여러 시나리오)
- [ ] 최적 계약 조합 추천 (AI 기반)

### **2. 1년 진행 상황표**
- [ ] 월별 이행 증빙 파일 업로드
- [ ] 이메일/SMS 알림 (매월 이행 마감일)
- [ ] 진행 상황 대시보드 (관리자)
- [ ] 공단 감면 신청 자동 작성 (API 연동)

### **3. 기타**
- [ ] 다년 계약 지원 (2~5년)
- [ ] 계약 갱신 자동 알림
- [ ] 감면 이력 관리 (연도별)

---

## 📞 10 문의

- **한국장애인고용공단**: 1588-1519
- **법적 근거**: 장애인고용촉진 및 직업재활법 제33조 (연계고용 부담금 감면)
- **공단 FAQ**: "연계고용대상시설은 2개 이상의 사업체와 계약 가능, 의무고용사업체도 2개 이상의 연계고용대상시설과 계약 가능"

---

## ✅ 11 체크리스트

- [x] 합산 감면 계산 API 구현
- [x] Zod 스키마 검증 추가
- [x] 감면 상한 계산 로직 구현 (90% + 50%)
- [x] 공급사별 감면액 비례 배분 구현
- [x] 장바구니 페이지에 공급사별 그룹화 UI 추가
- [x] 합산 감면 계산기 UI 추가
- [x] 1년 진행 상황표 모달 추가
- [x] 월별 체크리스트 (12개월) 구현
- [x] 진행률 프로그레스 바 추가
- [x] 민원 방지 문구 강조 표시
- [x] TypeScript 컴파일
- [x] PM2로 서비스 시작
- [x] Git 커밋
- [x] 데모 URL 확인

---

## 🎯 12 핵심 성과

### **A. 제도 준수**
✅ 공단 FAQ와 100% 일치하는 구조 구현  
✅ 감면 상한 정확히 적용 (부담금 90%, 도급액 50%)  
✅ 월별 이행 기준 명확히 안내

### **B. 사용자 편의성**
✅ 여러 표준사업장 상품을 한 번에 담고 계산 가능  
✅ 공급사별 도급액 자동 합산  
✅ 감면액 실시간 계산 및 시각화  
✅ 1년 진행 상황 관리 도구 제공

### **C. 민원 방지**
✅ 감면 상한 자동 적용으로 과다 기대 방지  
✅ 월별 이행 프로세스 명확히 안내  
✅ 주의사항 및 경고 메시지 강조  
✅ 법적 근거 및 문의처 명시

---

**완료일**: 2026-02-17  
**작업자**: AI Developer  
**프로젝트**: 장표사닷컴 (장애인표준사업장 연계고용 플랫폼)  
**Git 커밋**: 총 40회 (기존 39회 + 신규 1회)

🎉 **여러 표준사업장 동시 계약 지원 기능이 성공적으로 완료되었습니다!**
