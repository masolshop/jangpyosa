generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                String   @id @default(cuid())
  phone             String   @unique
  username          String?  @unique       // ğŸ†• ê¸°ì—… ë¡œê·¸ì¸ ID (ì˜ë¬¸+ìˆ«ì)
  email             String?
  passwordHash      String
  name              String
  role              String
  branchId          String?
  refCode           String?  @unique
  referredById      String?
  
  // ğŸ†• ê¸°ì—… ë‹´ë‹¹ì ì •ë³´ (SUPPLIER, BUYER ì „ìš©)
  managerName       String?                // ë‹´ë‹¹ì ì„±í•¨
  managerTitle      String?                // ë‹´ë‹¹ì ì§í•¨
  managerEmail      String?                // ë‹´ë‹¹ì ì´ë©”ì¼
  managerPhone      String?                // ë‹´ë‹¹ì í•¸ë“œí° (ì•Œë¦¼í†¡ìš©)
  
  // ğŸ†• ê°œì¸ì •ë³´ ë™ì˜
  privacyAgreed     Boolean  @default(false)
  privacyAgreedAt   DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  companyType       String?
  company           Company?
  referredBy        User?    @relation("Referrals", fields: [referredById], references: [id])
  referrals         User[]   @relation("Referrals")
  branch            Branch?  @relation(fields: [branchId], references: [id])
}

model Branch {
  id        String   @id @default(cuid())
  name      String   @unique
  code      String   @unique
  region    String?
  address   String?
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  agents    User[]
}

model Company {
  id              String           @id @default(cuid())
  name            String
  bizNo           String           @unique
  representative  String?
  type            String
  buyerType       String?          // ğŸ†• BUYER ì „ìš©: PRIVATE_COMPANY, PUBLIC_INSTITUTION, GOVERNMENT
  isVerified      Boolean          @default(false)
  apickData       String?
  ownerUserId     String           @unique
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  buyerProfile    BuyerProfile?
  ownerUser       User             @relation(fields: [ownerUserId], references: [id])
  supplierProfile SupplierProfile?
}

model SupplierRegistry {
  id              String            @id @default(cuid())
  certNo          String?
  name            String
  bizNo           String            @unique
  region          String?
  representative  String?
  address         String?
  certDate        String?
  contactTel      String?
  industry        String?
  companyType     String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  claimedProfiles SupplierProfile[]
}

model SupplierProfile {
  id                  String            @id @default(cuid())
  companyId           String            @unique
  region              String?
  industry            String?
  contactName         String?
  contactTel          String?
  approved            Boolean           @default(false)
  contractDescription String?
  minContractAmount   Int?
  maxContractAmount   Int?
  image1              String?
  image2              String?
  image3              String?
  image4              String?
  image5              String?
  detailPageContent   String?
  registryBizNo       String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  contractRequests    ContractRequest[]
  products            Product[]
  contracts           Contract[]        // ë„ê¸‰ê³„ì•½ ëª©ë¡ ì¶”ê°€
  registry            SupplierRegistry? @relation(fields: [registryBizNo], references: [bizNo])
  company             Company           @relation(fields: [companyId], references: [id])
}

model BuyerProfile {
  id                  String                 @id @default(cuid())
  companyId           String                 @unique
  employeeCount       Int                    @default(0)
  disabledCount       Int                    @default(0)
  yearlyEmployeesJson String?
  hasLevyExemption    Boolean                @default(false)  // ğŸ†• ë¶€ë‹´ê¸ˆ ë©´ì œ ì—¬ë¶€ (í˜„ì¬ëŠ” ì‚¬ìš© ì•ˆ í•¨, ëª¨ë‘ ë¶€ë‹´ê¸ˆ ë¶€ê³¼)
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  company             Company                @relation(fields: [companyId], references: [id])
  carts               Cart?
  contractRequests    ContractRequest[]
  disabledEmployees   DisabledEmployee[]
  calculations        Calculation[]
  contracts           Contract[]             // ë„ê¸‰ê³„ì•½ ëª©ë¡ ì¶”ê°€
  monthlyData         MonthlyEmployeeData[]  // ì›”ë³„ ë°ì´í„° ì¶”ê°€
}

// ì›”ë³„ ê³ ìš© ë°ì´í„° (ì •ë°€ ê³„ì‚°)
model MonthlyEmployeeData {
  id                    String       @id @default(cuid())
  buyerId               String
  year                  Int
  month                 Int
  
  // ì…ë ¥ ë°ì´í„°
  totalEmployeeCount    Int          @default(0)  // ìƒì‹œê·¼ë¡œì ìˆ˜ (ìˆ˜ë™ ì…ë ¥)
  
  // ìë™ ê³„ì‚° ë°ì´í„°
  disabledCount         Int          @default(0)  // ì¥ì• ì¸ ìˆ˜ (ìë™)
  recognizedCount       Float        @default(0)  // ì¸ì • ì¥ì• ì¸ ìˆ˜ (ì¤‘ì¦ 2ë°° í¬í•¨)
  obligatedCount        Int          @default(0)  // ì˜ë¬´ê³ ìš©ì¸ì› (ìë™)
  shortfallCount        Int          @default(0)  // ë¯¸ë‹¬ ì¸ì›
  surplusCount          Float        @default(0)  // ì´ˆê³¼ ì¸ì›
  
  // ê²°ê³¼
  levy                  Int          @default(0)  // ë¶€ë‹´ê¸ˆ (ì›)
  incentive             Int          @default(0)  // ì¥ë ¤ê¸ˆ (ì›)
  netAmount             Int          @default(0)  // ìˆœì•¡ (ì¥ë ¤ê¸ˆ - ë¶€ë‹´ê¸ˆ)
  
  // ìƒì„¸ ë‚´ì—­ (JSON)
  detailJson            String?      // ì§ì›ë³„ ìƒì„¸ ê³„ì‚° ë‚´ì—­
  
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  
  buyer                 BuyerProfile @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  
  @@unique([buyerId, year, month])
  @@index([buyerId, year])
}

model Product {
  id                      String          @id @default(cuid())
  supplierId              String
  title                   String
  category                String
  summary                 String?
  description             String?
  price                   Int
  unit                    String
  minOrderQty             Int             @default(1)
  leadTimeDays            Int             @default(7)
  deliveryCycle           String?
  spec                    String?
  processDescription      String?
  contractMinMonths       Int             @default(12)
  vatIncluded             Boolean         @default(true)
  shippingIncluded        Boolean         @default(false)
  extraCostNote           String?
  inspectionCriteria      String?
  defectPolicy            String?
  invoiceAvailable        Boolean         @default(true)
  quoteLeadTimeDays       Int             @default(3)
  thumbnailUrl            String?
  imageUrls               String?
  keywords                String?
  isActive                Boolean         @default(true)
  noSubcontractConfirm    Boolean         @default(false)
  monthlyDeliverySchedule String?
  monthlyBillingBasis     String?
  monthlyBillingDay       Int             @default(31)
  monthlyPaymentDay       Int             @default(10)
  monthlyFixedAmount      Int?
  monthlyAmountNote       String?
  costBreakdownJson       String?
  evidenceMethods         String?
  invoiceIssueConfirmed   Boolean         @default(false)
  receiptNote             String?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  cartItems               CartItem[]
  supplier                SupplierProfile @relation(fields: [supplierId], references: [id])
}

model Cart {
  id        String       @id @default(cuid())
  buyerId   String       @unique
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  buyer     BuyerProfile @relation(fields: [buyerId], references: [id])
  items     CartItem[]
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  qty       Int
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
}

model ContractRequest {
  id                          String          @id @default(cuid())
  buyerId                     String
  supplierId                  String
  totalAmount                 Int
  status                      String          @default("REQUESTED")
  requirements                String?
  durationMonths              Int?
  buyerAcceptedRiskDisclosure Boolean         @default(false)
  createdAt                   DateTime        @default(now())
  updatedAt                   DateTime        @updatedAt
  supplier                    SupplierProfile @relation(fields: [supplierId], references: [id])
  buyer                       BuyerProfile    @relation(fields: [buyerId], references: [id])
}

model YearSetting {
  year                   Int      @id @default(autoincrement())
  privateQuotaRate       Float
  publicQuotaRate        Float
  baseLevyAmount         Int
  maxReductionRate       Float    @default(0.9)
  maxReductionByContract Float    @default(0.5)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model Page {
  slug      String   @id
  title     String
  contentMd String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DisabledEmployee {
  id                     String       @id @default(cuid())
  buyerId                String
  name                   String
  registrationNumber     String?
  disabilityType         String
  disabilityGrade        String?
  severity               String
  gender                 String
  birthDate              DateTime?    // ìƒë…„ì›”ì¼ ì¶”ê°€ (ì—°ë ¹ë³„ ì¥ë ¤ê¸ˆ ê³„ì‚°ìš©)
  hireDate               DateTime
  resignDate             DateTime?
  monthlySalary          Int
  hasEmploymentInsurance Boolean      @default(true)
  meetsMinimumWage       Boolean      @default(true)
  workHoursPerWeek       Int?
  memo                   String?
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  buyer                  BuyerProfile @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([buyerId, resignDate])
}

model Calculation {
  id         String       @id @default(cuid())
  buyerId    String
  year       Int
  month      Int?
  type       String
  resultJson String
  createdAt  DateTime     @default(now())
  buyer      BuyerProfile @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([buyerId, year, month, type])
}

// ë„ê¸‰ê³„ì•½ì„œ (ë§ˆìŠ¤í„°)
model Contract {
  id                    String              @id @default(cuid())
  contractNo            String              @unique // ê³„ì•½ë²ˆí˜¸ (ì˜ˆ: CT-2026-0001)
  buyerId               String
  supplierId            String
  contractName          String              // ê³„ì•½ëª…
  startDate             DateTime            // ê³„ì•½ ì‹œì‘ì¼
  endDate               DateTime            // ê³„ì•½ ì¢…ë£Œì¼
  totalAmount           Int                 // ì´ ê³„ì•½ê¸ˆì•¡
  monthlyAmount         Int?                // ì›” ë‹¨ìœ„ ê¸ˆì•¡ (ê³ ì •ì¸ ê²½ìš°)
  status                String              @default("ACTIVE") // ACTIVE, SUSPENDED, TERMINATED, COMPLETED
  paymentTerms          String?             // ê²°ì œ ì¡°ê±´
  contractFileUrl       String?             // ê³„ì•½ì„œ íŒŒì¼ URL
  memo                  String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  buyer                 BuyerProfile        @relation(fields: [buyerId], references: [id])
  supplier              SupplierProfile     @relation(fields: [supplierId], references: [id])
  monthlyPerformances   MonthlyPerformance[]
  
  @@index([buyerId, status])
  @@index([supplierId, status])
  @@index([startDate, endDate])
}

// ì›”ë³„ ê³„ì•½ ì´í–‰ ë‚´ì—­
model MonthlyPerformance {
  id                   String    @id @default(cuid())
  contractId           String
  year                 Int       // ì—°ë„ (2026)
  month                Int       // ì›” (1-12)
  plannedAmount        Int       // ê³„íšê¸ˆì•¡ (ë‹¹ì›” ì˜ˆì •ì•¡)
  actualAmount         Int?      // ì‹¤ì œê¸ˆì•¡ (ì‹¤ì œ ì´í–‰ì•¡)
  performanceRate      Float?    // ì´í–‰ë¥  (%)
  description          String?   // ì´í–‰ ë‚´ì—­ ì„¤ëª…
  evidenceFileUrls     String?   // ì¦ë¹™ìë£Œ URL (JSON array)
  inspectionStatus     String    @default("PENDING") // PENDING, PASSED, FAILED, WAIVED
  inspectionDate       DateTime? // ê²€ìˆ˜ì¼
  inspectionNotes      String?   // ê²€ìˆ˜ ë©”ëª¨
  paymentStatus        String    @default("UNPAID") // UNPAID, PARTIAL, PAID, OVERDUE
  paymentAmount        Int?      // ì‹¤ì œ ì§€ê¸‰ì•¡
  paymentDate          DateTime? // ì§€ê¸‰ì¼
  paymentMethod        String?   // ì§€ê¸‰ ë°©ë²• (ê³„ì¢Œì´ì²´, ì–´ìŒ ë“±)
  paymentReference     String?   // ì§€ê¸‰ ì°¸ì¡°ë²ˆí˜¸
  invoiceNo            String?   // ì„¸ê¸ˆê³„ì‚°ì„œ ë²ˆí˜¸
  invoiceDate          DateTime? // ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ì¼
  invoiceFileUrl       String?   // ì„¸ê¸ˆê³„ì‚°ì„œ íŒŒì¼ URL
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  contract             Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  @@unique([contractId, year, month])
  @@index([contractId, year, month])
  @@index([inspectionStatus, paymentStatus])
}

// ê²°ì œ ì´ë ¥ (ìƒì„¸ ë¡œê·¸)
model PaymentHistory {
  id              String    @id @default(cuid())
  performanceId   String    // MonthlyPerformance ID
  amount          Int       // ê²°ì œ ê¸ˆì•¡
  paymentDate     DateTime  // ê²°ì œì¼
  paymentMethod   String    // ê²°ì œ ë°©ë²•
  reference       String?   // ì°¸ì¡°ë²ˆí˜¸ (ê±°ë˜ë²ˆí˜¸ ë“±)
  status          String    @default("COMPLETED") // COMPLETED, CANCELLED, REFUNDED
  memo            String?
  createdBy       String?   // ì²˜ë¦¬ì User ID
  createdAt       DateTime  @default(now())
  
  @@index([performanceId])
  @@index([paymentDate])
}
