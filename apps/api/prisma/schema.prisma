generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id           String   @id @default(cuid())
  phone        String   @unique
  email        String?
  passwordHash String
  name         String
  role         String
  branchId     String?
  refCode      String?  @unique
  referredById String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  companyType  String?
  company      Company?
  referredBy   User?    @relation("Referrals", fields: [referredById], references: [id])
  referrals    User[]   @relation("Referrals")
  branch       Branch?  @relation(fields: [branchId], references: [id])
}

model Branch {
  id        String   @id @default(cuid())
  name      String   @unique
  code      String   @unique
  region    String?
  address   String?
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  agents    User[]
}

model Company {
  id              String           @id @default(cuid())
  name            String
  bizNo           String           @unique
  representative  String?
  type            String
  isVerified      Boolean          @default(false)
  apickData       String?
  ownerUserId     String           @unique
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  buyerProfile    BuyerProfile?
  ownerUser       User             @relation(fields: [ownerUserId], references: [id])
  supplierProfile SupplierProfile?
}

model SupplierRegistry {
  id              String            @id @default(cuid())
  certNo          String?
  name            String
  bizNo           String            @unique
  region          String?
  representative  String?
  address         String?
  certDate        String?
  contactTel      String?
  industry        String?
  companyType     String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  claimedProfiles SupplierProfile[]
}

model SupplierProfile {
  id                  String            @id @default(cuid())
  companyId           String            @unique
  region              String?
  industry            String?
  contactName         String?
  contactTel          String?
  approved            Boolean           @default(false)
  contractDescription String?
  minContractAmount   Int?
  maxContractAmount   Int?
  image1              String?
  image2              String?
  image3              String?
  image4              String?
  image5              String?
  detailPageContent   String?
  registryBizNo       String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  contractRequests    ContractRequest[]
  products            Product[]
  registry            SupplierRegistry? @relation(fields: [registryBizNo], references: [bizNo])
  company             Company           @relation(fields: [companyId], references: [id])
}

model BuyerProfile {
  id                  String            @id @default(cuid())
  companyId           String            @unique
  employeeCount       Int               @default(0)
  disabledCount       Int               @default(0)
  yearlyEmployeesJson String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  company             Company           @relation(fields: [companyId], references: [id])
  carts               Cart?
  contractRequests    ContractRequest[]
  disabledEmployees   DisabledEmployee[]
  calculations        Calculation[]
}

model Product {
  id                      String          @id @default(cuid())
  supplierId              String
  title                   String
  category                String
  summary                 String?
  description             String?
  price                   Int
  unit                    String
  minOrderQty             Int             @default(1)
  leadTimeDays            Int             @default(7)
  deliveryCycle           String?
  spec                    String?
  processDescription      String?
  contractMinMonths       Int             @default(12)
  vatIncluded             Boolean         @default(true)
  shippingIncluded        Boolean         @default(false)
  extraCostNote           String?
  inspectionCriteria      String?
  defectPolicy            String?
  invoiceAvailable        Boolean         @default(true)
  quoteLeadTimeDays       Int             @default(3)
  thumbnailUrl            String?
  imageUrls               String?
  keywords                String?
  isActive                Boolean         @default(true)
  noSubcontractConfirm    Boolean         @default(false)
  monthlyDeliverySchedule String?
  monthlyBillingBasis     String?
  monthlyBillingDay       Int             @default(31)
  monthlyPaymentDay       Int             @default(10)
  monthlyFixedAmount      Int?
  monthlyAmountNote       String?
  costBreakdownJson       String?
  evidenceMethods         String?
  invoiceIssueConfirmed   Boolean         @default(false)
  receiptNote             String?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  cartItems               CartItem[]
  supplier                SupplierProfile @relation(fields: [supplierId], references: [id])
}

model Cart {
  id        String       @id @default(cuid())
  buyerId   String       @unique
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  buyer     BuyerProfile @relation(fields: [buyerId], references: [id])
  items     CartItem[]
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  qty       Int
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
}

model ContractRequest {
  id                          String          @id @default(cuid())
  buyerId                     String
  supplierId                  String
  totalAmount                 Int
  status                      String          @default("REQUESTED")
  requirements                String?
  durationMonths              Int?
  buyerAcceptedRiskDisclosure Boolean         @default(false)
  createdAt                   DateTime        @default(now())
  updatedAt                   DateTime        @updatedAt
  supplier                    SupplierProfile @relation(fields: [supplierId], references: [id])
  buyer                       BuyerProfile    @relation(fields: [buyerId], references: [id])
}

model YearSetting {
  year                   Int      @id @default(autoincrement())
  privateQuotaRate       Float
  publicQuotaRate        Float
  baseLevyAmount         Int
  maxReductionRate       Float    @default(0.9)
  maxReductionByContract Float    @default(0.5)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model Page {
  slug      String   @id
  title     String
  contentMd String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DisabledEmployee {
  id                     String       @id @default(cuid())
  buyerId                String
  name                   String
  registrationNumber     String?
  disabilityType         String
  disabilityGrade        String?
  severity               String
  gender                 String
  hireDate               DateTime
  resignDate             DateTime?
  monthlySalary          Int
  hasEmploymentInsurance Boolean      @default(true)
  meetsMinimumWage       Boolean      @default(true)
  workHoursPerWeek       Int?
  memo                   String?
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  buyer                  BuyerProfile @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([buyerId, resignDate])
}

model Calculation {
  id         String       @id @default(cuid())
  buyerId    String
  year       Int
  month      Int?
  type       String
  resultJson String
  createdAt  DateTime     @default(now())
  buyer      BuyerProfile @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([buyerId, year, month, type])
}
