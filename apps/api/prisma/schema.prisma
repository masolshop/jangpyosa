generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id           String   @id @default(cuid())
  phone        String   @unique
  email        String?
  passwordHash String
  name         String
  role         String
  branchId     String?
  refCode      String?  @unique
  referredById String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  companyType  String?
  company      Company?
  referredBy   User?    @relation("Referrals", fields: [referredById], references: [id])
  referrals    User[]   @relation("Referrals")
  branch       Branch?  @relation(fields: [branchId], references: [id])
}

model Branch {
  id        String   @id @default(cuid())
  name      String   @unique
  code      String   @unique
  region    String?
  address   String?
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  agents    User[]
}

model Company {
  id              String           @id @default(cuid())
  name            String
  bizNo           String           @unique
  representative  String?
  type            String
  isVerified      Boolean          @default(false)
  apickData       String?
  ownerUserId     String           @unique
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  buyerProfile    BuyerProfile?
  ownerUser       User             @relation(fields: [ownerUserId], references: [id])
  supplierProfile SupplierProfile?
}

model SupplierRegistry {
  id              String            @id @default(cuid())
  certNo          String?
  name            String
  bizNo           String            @unique
  region          String?
  representative  String?
  address         String?
  certDate        String?
  contactTel      String?
  industry        String?
  companyType     String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  claimedProfiles SupplierProfile[]
}

model SupplierProfile {
  id                  String            @id @default(cuid())
  companyId           String            @unique
  region              String?
  industry            String?
  contactName         String?
  contactTel          String?
  approved            Boolean           @default(false)
  contractDescription String?
  minContractAmount   Int?
  maxContractAmount   Int?
  image1              String?
  image2              String?
  image3              String?
  image4              String?
  image5              String?
  detailPageContent   String?
  registryBizNo       String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  contractRequests    ContractRequest[]
  products            Product[]
  contracts           Contract[]        // 도급계약 목록 추가
  registry            SupplierRegistry? @relation(fields: [registryBizNo], references: [bizNo])
  company             Company           @relation(fields: [companyId], references: [id])
}

model BuyerProfile {
  id                  String            @id @default(cuid())
  companyId           String            @unique
  employeeCount       Int               @default(0)
  disabledCount       Int               @default(0)
  yearlyEmployeesJson String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  company             Company           @relation(fields: [companyId], references: [id])
  carts               Cart?
  contractRequests    ContractRequest[]
  disabledEmployees   DisabledEmployee[]
  calculations        Calculation[]
  contracts           Contract[]        // 도급계약 목록 추가
}

model Product {
  id                      String          @id @default(cuid())
  supplierId              String
  title                   String
  category                String
  summary                 String?
  description             String?
  price                   Int
  unit                    String
  minOrderQty             Int             @default(1)
  leadTimeDays            Int             @default(7)
  deliveryCycle           String?
  spec                    String?
  processDescription      String?
  contractMinMonths       Int             @default(12)
  vatIncluded             Boolean         @default(true)
  shippingIncluded        Boolean         @default(false)
  extraCostNote           String?
  inspectionCriteria      String?
  defectPolicy            String?
  invoiceAvailable        Boolean         @default(true)
  quoteLeadTimeDays       Int             @default(3)
  thumbnailUrl            String?
  imageUrls               String?
  keywords                String?
  isActive                Boolean         @default(true)
  noSubcontractConfirm    Boolean         @default(false)
  monthlyDeliverySchedule String?
  monthlyBillingBasis     String?
  monthlyBillingDay       Int             @default(31)
  monthlyPaymentDay       Int             @default(10)
  monthlyFixedAmount      Int?
  monthlyAmountNote       String?
  costBreakdownJson       String?
  evidenceMethods         String?
  invoiceIssueConfirmed   Boolean         @default(false)
  receiptNote             String?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  cartItems               CartItem[]
  supplier                SupplierProfile @relation(fields: [supplierId], references: [id])
}

model Cart {
  id        String       @id @default(cuid())
  buyerId   String       @unique
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  buyer     BuyerProfile @relation(fields: [buyerId], references: [id])
  items     CartItem[]
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  qty       Int
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
}

model ContractRequest {
  id                          String          @id @default(cuid())
  buyerId                     String
  supplierId                  String
  totalAmount                 Int
  status                      String          @default("REQUESTED")
  requirements                String?
  durationMonths              Int?
  buyerAcceptedRiskDisclosure Boolean         @default(false)
  createdAt                   DateTime        @default(now())
  updatedAt                   DateTime        @updatedAt
  supplier                    SupplierProfile @relation(fields: [supplierId], references: [id])
  buyer                       BuyerProfile    @relation(fields: [buyerId], references: [id])
}

model YearSetting {
  year                   Int      @id @default(autoincrement())
  privateQuotaRate       Float
  publicQuotaRate        Float
  baseLevyAmount         Int
  maxReductionRate       Float    @default(0.9)
  maxReductionByContract Float    @default(0.5)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model Page {
  slug      String   @id
  title     String
  contentMd String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DisabledEmployee {
  id                     String       @id @default(cuid())
  buyerId                String
  name                   String
  registrationNumber     String?
  disabilityType         String
  disabilityGrade        String?
  severity               String
  gender                 String
  hireDate               DateTime
  resignDate             DateTime?
  monthlySalary          Int
  hasEmploymentInsurance Boolean      @default(true)
  meetsMinimumWage       Boolean      @default(true)
  workHoursPerWeek       Int?
  memo                   String?
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  buyer                  BuyerProfile @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([buyerId, resignDate])
}

model Calculation {
  id         String       @id @default(cuid())
  buyerId    String
  year       Int
  month      Int?
  type       String
  resultJson String
  createdAt  DateTime     @default(now())
  buyer      BuyerProfile @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([buyerId, year, month, type])
}

// 도급계약서 (마스터)
model Contract {
  id                    String              @id @default(cuid())
  contractNo            String              @unique // 계약번호 (예: CT-2026-0001)
  buyerId               String
  supplierId            String
  contractName          String              // 계약명
  startDate             DateTime            // 계약 시작일
  endDate               DateTime            // 계약 종료일
  totalAmount           Int                 // 총 계약금액
  monthlyAmount         Int?                // 월 단위 금액 (고정인 경우)
  status                String              @default("ACTIVE") // ACTIVE, SUSPENDED, TERMINATED, COMPLETED
  paymentTerms          String?             // 결제 조건
  contractFileUrl       String?             // 계약서 파일 URL
  memo                  String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  buyer                 BuyerProfile        @relation(fields: [buyerId], references: [id])
  supplier              SupplierProfile     @relation(fields: [supplierId], references: [id])
  monthlyPerformances   MonthlyPerformance[]
  
  @@index([buyerId, status])
  @@index([supplierId, status])
  @@index([startDate, endDate])
}

// 월별 계약 이행 내역
model MonthlyPerformance {
  id                   String    @id @default(cuid())
  contractId           String
  year                 Int       // 연도 (2026)
  month                Int       // 월 (1-12)
  plannedAmount        Int       // 계획금액 (당월 예정액)
  actualAmount         Int?      // 실제금액 (실제 이행액)
  performanceRate      Float?    // 이행률 (%)
  description          String?   // 이행 내역 설명
  evidenceFileUrls     String?   // 증빙자료 URL (JSON array)
  inspectionStatus     String    @default("PENDING") // PENDING, PASSED, FAILED, WAIVED
  inspectionDate       DateTime? // 검수일
  inspectionNotes      String?   // 검수 메모
  paymentStatus        String    @default("UNPAID") // UNPAID, PARTIAL, PAID, OVERDUE
  paymentAmount        Int?      // 실제 지급액
  paymentDate          DateTime? // 지급일
  paymentMethod        String?   // 지급 방법 (계좌이체, 어음 등)
  paymentReference     String?   // 지급 참조번호
  invoiceNo            String?   // 세금계산서 번호
  invoiceDate          DateTime? // 세금계산서 발행일
  invoiceFileUrl       String?   // 세금계산서 파일 URL
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  contract             Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  @@unique([contractId, year, month])
  @@index([contractId, year, month])
  @@index([inspectionStatus, paymentStatus])
}

// 결제 이력 (상세 로그)
model PaymentHistory {
  id              String    @id @default(cuid())
  performanceId   String    // MonthlyPerformance ID
  amount          Int       // 결제 금액
  paymentDate     DateTime  // 결제일
  paymentMethod   String    // 결제 방법
  reference       String?   // 참조번호 (거래번호 등)
  status          String    @default("COMPLETED") // COMPLETED, CANCELLED, REFUNDED
  memo            String?
  createdBy       String?   // 처리자 User ID
  createdAt       DateTime  @default(now())
  
  @@index([performanceId])
  @@index([paymentDate])
}
